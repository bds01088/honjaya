# [FE] ë°°í¬ ë° openVidu

## í™˜ê²½ ì„¤ì •

- Amazon EC2 - Ubuntu 20.04
- Nginx - 1.18.0
- docker - 20.10.17
- openvidu
    - kurento/kurento-media-server - 6.16.0
    - openvidu/openvidu-coturn - 2.22.0
    - openvidu/openvidu-proxy - 2.22.0
    - openvidu/openvidu-server - 2.22.0
    - openvidu/openvidu-call - 2.22.0

---

## ë°°í¬ ë°©ë²•

> ì•„ë˜ ec2 ì„œë²„ ë‚´ì— ëª¨ë“  ì–´í”Œë“¤ì„ ì„¤ì¹˜ ë° ì„¤ì • í›„ ë¹Œë“œí•˜ë©´ ëœë‹¤
> 

[[FE] ë¹Œë“œ í›„ ë°°í¬]([FE] ë¹Œë“œ í›„ ë°°í¬.md)

<aside>
ğŸ’¡ openvidu ì„¤ì¹˜ ì „ì— nginxë¥¼ ë¨¼ì € ê¹”ì§€ ì•Šê±°ë‚˜, nginxë¥¼ ì •ì§€ì‹œí‚¨ ë‹¤ìŒ
ì§„í–‰ í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

</aside>

---

## NGINX ì„¤ì¹˜

```bash
sudo apt update
# Nginx ì„¤ì¹˜
sudo apt install nginx
# ì„¤ì¹˜ëœ Nginx ë²„ì „í™•ì¸
sudo nginx -v
```

## NGINX ì„¤ì •

> [[FE] nginx ìˆ˜ë™ ë°°í¬(í”„ë¡œì íŠ¸ ì§„í–‰ ë‹¹ì‹œ)]([FE] nginx ìˆ˜ë™ ë°°í¬.md)

```bash
cd /etc/nginx/site-available/

íŒŒì¼ìˆ˜ì •ëª…ë ¹ì–´ default
ex) nano default
```

```bash
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        # httpsí¬íŠ¸(443) ì‚¬ìš©í•˜ê¸°
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

				#í”„ë¡ íŠ¸ ë¹Œë“œ íŒŒì¼ì„ ê°€ì ¸ì˜¬ ê²½ë¡œ
        root /var/www/html/build;

        # Add index.php to the list if you are using PHP
				# ê²½ë¡œì— ì¡´ì¬í•˜ëŠ” ë³´ì—¬ì¤„ í”„ë¡ íŠ¸ í˜ì´ì§€ íŒŒì¼ ì´ë¦„
        index index.html;
				
				#ë„ë©”ì¸ ì´ë¦„
        server_name i7e104.p.ssafy.io;
				#https ë³´ì•ˆ í¬íŠ¸ ì ‘ì†ì— ì‚¬ìš©í•  ì¸ì¦ì„œ ìœ„ì¹˜
				#certbot nginxì„¤ì • í¬í•¨ ì¸ì¦ì„œ ë°œê¸‰ì‹œ ìë™ìœ¼ë¡œ ê¸°ì…ë˜ì§€ë§Œ
				#ë‚˜ëŠ” ì´ë•Œ 5íšŒ ë°œê¸‰ì´ˆê³¼ì—¬ì„œ zerosslì´ë¼ëŠ” ë˜ë‹¤ë¥¸ ë¬´ë£Œ ì¸ì¦ì„œ ë°œê¸‰ì‚¬ì´íŠ¸ë¥¼ ì‚¬ìš©í•¨
        ssl_certificate /home/ubuntu/zerossl/certificate.crt;
        ssl_certificate_key /home/ubuntu/zerossl/private.key;

				#í•´ë‹¹ ë„ë©”ì¸(location) ë’¤ì— ì˜¬ ê²½ë¡œì— ë”°ë¼ ë¶„ê¸°
        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ /index.html;
        }
				#ë°±ì—”ë“œ ê²½ë¡œ
        location /honjaya {
                proxy_pass http://localhost:8080;
                proxy_redirect off;
								#stompì±„íŒ… ê´€ë ¨ë˜ì„œ sockJSì˜ ë²„ì „ì´ ë§ì§€ì•Šì•„ http ë²„ì „ì„ ì¬ì„¤ì •í•¨
                proxy_http_version 1.1;
                charset utf-8;

                proxy_set_header X-Readl-IP $remote_addr;
                proxy_set_header X-Forwarded-for @proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
								#sockJSì— ì˜í•œ ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•œ ì¶”ê°€ í•´ë”
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }

        # pass PHP scripts to FastCGI server
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
        #       fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}
```

---

## docker ì„¤ì¹˜

> ë„ì»¤ ì„¤ì¹˜ ê³µì‹ í™ˆí˜ì´ì§€
[https://docs.docker.com/engine/install/ubuntu/](https://docs.docker.com/engine/install/ubuntu/)
> 
1. Set up the repository
    - ë„ì»¤ ì´ì „ ë²„ì „ ì‚­ì œ ë° í™•ì¸
    
    ```bash
    $ sudo apt-get remove docker docker-engine docker.io containerd runc
    ```
    
    - repoêµ¬ì„± ë° GPG í‚¤ ë°›ì•„ì˜¤ê¸°
    
    ```bash
    $ sudo apt-get update
    $ sudo apt-get install \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    ```
    
    - curlì´ ì—†ë‹¤ë©´, ê²€ìƒ‰í•´ì„œ ë‹¤ìš´ ë°›ì•„ì„œ ì‚¬ìš©
    
    ```
    $ sudo mkdir -p /etc/apt/keyrings
    $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    ```
    
    ```bash
    $ echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
2. Install Docker Engine
    - ì„¤ì¹˜
    - íŠ¹ì • ë²„ì „ ì„¤ì¹˜ëŠ” ê³µì‹ í™ˆí˜ì´ì§€ ì°¸ì¡°

```
 $ sudo apt-get update
 $ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

---

## openVidu ì„¤ì¹˜

> ì¶”ê°€ ì°¸ì¡° (ì§„í–‰ ë‹¹ì‹œ ê¸°ë¡)
> 
> [[FE] OpenVidu (í”„ë¡œì íŠ¸ ì§„í–‰ ë‹¹ì‹œ)](OpenVidu ê´€ë ¨ ë‚´ìš©.md)

> openVidu ì„œë²„
[https://docs.openvidu.io/en/2.22.0/deployment/ce/on-premises/](https://docs.openvidu.io/en/2.22.0/deployment/ce/on-premises/)
openVidu ì‚¬ìš© ì½”ë“œ
[https://docs.openvidu.io/en/2.22.0/tutorials/openvidu-insecure-react/](https://docs.openvidu.io/en/2.22.0/tutorials/openvidu-insecure-react/)

<aside>
ğŸ’¡ ë„ì»¤ ì„¤ì¹˜ ì„ í–‰ í•„ìˆ˜ì´ë©°, nginx ë¯¸ì„¤ì¹˜ ìƒíƒœ ë˜ëŠ” ì •ì§€ ìƒíƒœì—ì„œ ê¹”ì•„ì•¼í•œë‹¤
</aside>

<aside>
ğŸ’¡ WebRTCì˜ ê²½ìš°, localì—ì„œëŠ” ì¸ì¦ì„œ ì—†ì´ ì˜ìƒ ë° ì†Œë¦¬ê°€ ì£¼ê³  ë°›ì•„ì§€ì§€ë§Œ, ë°°í¬ëœ openVidu ì„œë²„ ë˜ëŠ” ë°°í¬ëœ í™ˆí˜ì´ì§€ì—ì„œ ì ‘ê·¼í•  ê²½ìš° ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆë‹¤.
</aside>

### í¬íŠ¸ ì—´ê¸°

![Untitled]([FE] ë°°í¬ ë° openVidu.assets/Untitled.png)

- ìœ„ì— í•´ë‹¹ë˜ëŠ” í¬íŠ¸ë¥¼ ì „ë¶€ ì—´ì–´ì¤€ë‹¤.
    - í¬íŠ¸ë¥¼ ì—¬ëŠ” ëª…ë ¹ì–´ : sudo ufw allow portnum
    ì—°ì†ëœ í¬íŠ¸ë¥¼ ì—¬ëŠ” ëª…ë ¹ì–´ : sudo ufw allow portn1:portn2/tcp ë˜ëŠ” udp

### ì„¤ì¹˜

```bash
$ sudo su
$ cd /opt
$ curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
```

## openVidu ì„¤ì •

<aside>
ğŸ’¡ ë°°í¬í•˜ì—¬ ì‚¬ìš©í•˜ë ¤ë©´ certbotì„ í†µí•œ letsencryptì˜ ì¸ì¦ì„œ ë°œê¸‰ ë°›ì•„ì•¼ í•¨

</aside>

```bash
# OpenVidu configuration
# ----------------------
# Documentation: https://docs.openvidu.io/en/stable/reference-docs/openvidu-config/

# NOTE: This file doesn't need to quote assignment values, like most shells do.
# All values are stored as-is, even if they contain spaces, so don't quote them.

# Domain name. If you do not have one, the public IP of the machine.
# For example: 198.51.100.1, or openvidu.example.com
# ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸
DOMAIN_OR_PUBLIC_IP=i7e104.p.ssafy.io

# OpenVidu SECRET used for apps to connect to OpenVidu server and users to access to OpenVidu Dashboard
# ì˜¤í”ˆë¹„ë‘ ì„œë²„ì™€ í”„ë¡ íŠ¸ì˜ ì—°ê²° ì‹œ ë¹„ë°€ë²ˆí˜¸ ê°™ì€ ê±°
OPENVIDU_SECRET=MY_SECRET

# Certificate type:
# - selfsigned:  Self signed certificate. Not recommended for production use.
#                Users will see an ERROR when connected to web page.
# - owncert:     Valid certificate purchased in a Internet services company.
#                Please put the certificates files inside folder ./owncert
#                with names certificate.key and certificate.cert
# - letsencrypt: Generate a new certificate using letsencrypt. Please set the
#                required contact email for Let's Encrypt in LETSENCRYPT_EMAIL
#                variable.
# ë¡œì»¬ ê°œë°œ ë‹¹ì‹œì—ëŠ” selfsignedë¡œ ë†“ê³  ì‚¬ìš©í•˜ë©´ ê²½ê³ ë¬¸êµ¬ë§Œ ëœ¨ê³  ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.
# ë°°í¬í•˜ê²Œëœë‹¤ë©´ letsencrypt ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•´ì•¼í•œë‹¤.
CERTIFICATE_TYPE=letsencrypt

# If CERTIFICATE_TYPE=letsencrypt, you need to configure a valid email for notifications
# letsencrypt ì¸ì¦ì„œ ë°œê¸‰ì‹œ ì‚¬ìš©ë˜ëŠ” ì´ë©”ì¼ ì…ë ¥
# ì‹¤ì§ˆì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ì´ë©”ì¼ì„ ì ìœ¼ë©´ ëœë‹¤. asdf1234@naver.com ê°™ì€ ê²ƒë„ ì‚¬ìš©ê°€ëŠ¥í•˜ì§€ë§Œ,
# í˜¹ì‹œë‚˜ ëª¨ë¥¼ ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ê¸°ìœ„í•´ ì¶”í›„ ë°œê¸‰í•  certbotì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¸ì¦ì„œì™€ ê°™ì€ ì´ë©”ì¼ì„ ì“°ì
LETSENCRYPT_EMAIL=bds01088@naver.com

# Proxy configuration
# If you want to change the ports on which openvidu listens, uncomment the following lines

# Allows any request to http://DOMAIN_OR_PUBLIC_IP:HTTP_PORT/ to be automatically
# redirected to https://DOMAIN_OR_PUBLIC_IP:HTTPS_PORT/.
# WARNING: the default port 80 cannot be changed during the first boot
# if you have chosen to deploy with the option CERTIFICATE_TYPE=letsencrypt
# openvidu ë‚´ë¶€ì— ì¡´ì¬í•˜ëŠ” nginxê°€ ë°›ì•„ì˜¤ëŠ” í¬íŠ¸ì¼ ë“¯í•¨
# í”„ë¡ íŠ¸ì—ì„œ ì‹¤ì œ ì˜¤í”ˆë¹„ë‘ ì„œë²„ë¥¼ ì ‘ì†í• ë•Œ ì‚¬ìš©ë˜ëŠ” í¬íŠ¸
# ì£¼ë¡œ sslì„ ì‚¬ìš©í•œë‹¤ë©´ 4443í¬íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤.
HTTP_PORT=4442

# Changes the port of all services exposed by OpenVidu.
# SDKs, REST clients and browsers will have to connect to this port
HTTPS_PORT=4443

# Old paths are considered now deprecated, but still supported by default.
# OpenVidu Server will log a WARN message every time a deprecated path is called, indicating
```

- í”„ë¡ íŠ¸ì—ì„œ ì„œë²„ ì—°ê²° ì‹œ ì£¼ì†Œ == https://DOMAIN_OR_PUBLIC_IP:HTTPS_PORT/

---

## ì¸ì¦ì„œ ë°œê¸‰

> certbot ê³µì‹ í™ˆí˜ì´ì§€
[https://certbot.eff.org/instructions?ws=nginx&os=ubuntufocal](https://certbot.eff.org/instructions?ws=nginx&os=ubuntufocal)
nginx-ubuntu20 ì¼ ë•Œ ì„¤ì¹˜ ë°©ë²•
> 

<aside>
ğŸ’¡ í•˜ë‚˜ì˜ ë„ë©”ì¸ì—ëŠ” ì¼ì£¼ì¼ì— 5ë²ˆë§Œ ë°œê¸‰ì´ ê°€ëŠ¥í•˜ë‹¤

</aside>

### certbot ì„¤ì¹˜

- $ `sudo snap install core; sudo snap refresh core`
- $ `sudo snap install --classic certbot`

### certbotì„ í†µí•œ ì¸ì¦ì„œ ë°œê¸‰

- `sudo certbot --nginx`
    - nginx ì´ìš© ì‹œ ìë™ìœ¼ë¡œ httpsë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ nginxì— ì„¤ì •ì„ ê¸°ì…í•´ì¤Œ
- `sudo certbot renew --dry-run`
    - ë‹¨ìˆœíˆ ì¸ì¦ì„œë§Œ ë°›ì•„ì˜¬ ë•Œ

### ì¸ì¦ì„œ ë°œê¸‰ í™•ì¸

```bash
$ sudo su
$ cd /etc/letsencrypt/live/
```

- í•´ë‹¹ í´ë” ì•ˆì— ì¸ì¦ì„œë¥¼ ë°œê¸‰ ë°›ì€ ë„ë©”ì¸ì˜ ì´ë¦„ìœ¼ë¡œ í´ë”ê°€ ì¡´ì¬í•œë‹¤ë©´ ì„±ê³µí•œ ê²ƒì„

---

## openVidu í•´ê²°í•˜ê¸° ì–´ë ¤ì› ë˜ ë¬¸ì œì 

<aside>
ğŸ’¡ letsencryptë¥¼ í†µí•œ ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ ë° openviduì˜ ì¸ì¦ ë°©ì‹ì„ letsencryptë¡œ ì„¤ì •í•˜ì˜€ìŒì—ë„ ì¸ì¦ì„œ ì˜¤ë¥˜ë¡œ ì¸í•œ ë°°í¬ëœ í™˜ê²½ì—ì„œ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•  ê²½ìš°

</aside>

<aside>
ğŸ’¡ ë˜í•œ docker-compose logs nginxë¥¼ í†µí•´ ì‹¤í–‰ ì¤‘ì¸ openvidu nginxì˜ ë¡œê·¸ë¥¼ ë³´ê³  ê·¸ ì¤‘ ì¸ì¦ì„œë¥¼ ì°¾ì§€ ëª»í–ˆë‹¤ëŠ” ì—ëŸ¬ë¥¼ ë°œê²¬í–ˆì„ ê²½ìš°

</aside>

> í•´ê²°í•´ì£¼ì‹  ì•ˆXXë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤
> 

```bash
cd /opt/openvidu/
nano docker-compose.yml
```

```bash
nginx:
        image: openvidu/openvidu-proxy:2.22.0
        restart: always
        network_mode: host
        volumes:
            - /etc/letsencrypt:/etc/letsencrypt
            - ./owncert:/owncert
            - ./custom-nginx-vhosts:/etc/nginx/vhost.d/
            - ./custom-nginx-locations:/custom-nginx-locations
            - ${OPENVIDU_RECORDING_CUSTOM_LAYOUT}:/opt/openvidu/custom-layout
        environment:
            - DOMAIN_OR_PUBLIC_IP=${DOMAIN_OR_PUBLIC_IP}
            - CERTIFICATE_TYPE=${CERTIFICATE_TYPE}
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
            - PROXY_HTTP_PORT=${HTTP_PORT:-}
            - PROXY_HTTPS_PORT=${HTTPS_PORT:-}
            - PROXY_HTTPS_PROTOCOLS=${HTTPS_PROTOCOLS:-}
            - PROXY_HTTPS_CIPHERS=${HTTPS_CIPHERS:-}
            - PROXY_HTTPS_HSTS=${HTTPS_HSTS:-}
```

- ìœ„ êµ¬ì¡°ì—ì„œ volumesì— letsencryptë¥¼ ìœ„ì™€ ê°™ì´ ìˆ˜ì •í•´ì£¼ë©´ ë  ë“¯í•˜ë‹¤
í˜„ì¬ ìˆ˜ì •ë˜ì–´ì„œ ì´ì „ì— ì–´ë–¤ í˜•íƒœë¡œ ê¸°ì…ë˜ì–´ ìˆëŠ”ì§€ ê¸°ì–µì€ ì•ˆë‚œë‹¤.
- í•´ë‹¹ openvidu nginxê°€ ec2ì„œë²„ ë‚´ì— ì¸ì¦ì„œë¥¼ docker ë‚´ë¶€ê¹Œì§€ ë§¤í•‘ì„ í•˜ì§€ ëª»í•´ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì´ë¯€ë¡œ ê°•ì œë¡œ ì£¼ì†Œë¥¼ í•˜ë“œì½”ë”©? í–ˆë˜ ê²ƒìœ¼ë¡œ ê¸°ì–µí•œë‹¤.
