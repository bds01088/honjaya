<!DOCTYPE html>
<html
  lang="en"
  xmlns:v-on="http://www.w3.org/1999/xhtml"
  xmlns:v-bind="http://www.w3.org/1999/xhtml"
>
  <head>
    <title>Websocket Chat</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <!-- CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
      [v-cloak] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app" v-cloak>
      <div class="row">
        <div class="col-md-12">
          <h3>채팅방 리스트</h3>
        </div>
      </div>

      <label for="chatAskTo">채팅 신청할 유저 번호</label>
      <input id="chatAskTo" v-model="chatAskTo" type="text" />
      <button class="btn btn-sm btn-primary" @click="askChat">대화 요청하기</button>

      <ul class="list-group">
        <li
          class="list-group-item list-group-item-action"
          v-for="item in chatrooms"
          v-bind:key="item.chatroomNo"
          v-on:click="enterRoom(item.chatroomNo)"
        >
          {{item.userNickname}}
        </li>
      </ul>
    </div>
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      var vm = new Vue({
        el: "#app",
        data: {
          chatrooms: [],
          chatAskTo: 0,
        },
        created() {
          this.findAllRoom();
        },
        methods: {
          findAllRoom: function () {
            let headers = {
              "Content-Type": "application/json",
              Accept: "application/json",
              "access-token":
                "eyJ0eXAiOiJKV1QiLCJyZWdEYXRlIjoxNjYwMzE5NTYxMzUzLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NjAzNTU1NjEsInN1YiI6ImFjY2Vzcy10b2tlbiIsInVzZXJObyI6MX0.4p6UpRi17Ut-ZzkbOM6meZ8Lw5R2rct41YbVEcXCRwo",
            };
            axios.get("/honjaya/chats/list", { headers: headers }).then((response) => {
              let { data } = response;
              if (data.success) {
                this.chatrooms = data.list;
              } else {
                console.log(data.error);
              }
            });
          },
          askChat: function () {
            let headers = {
              "Content-Type": "application/json",
              Accept: "application/json",
              "access-token":
                "eyJ0eXAiOiJKV1QiLCJyZWdEYXRlIjoxNjYwMzE5NTYxMzUzLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NjAzNTU1NjEsInN1YiI6ImFjY2Vzcy10b2tlbiIsInVzZXJObyI6MX0.4p6UpRi17Ut-ZzkbOM6meZ8Lw5R2rct41YbVEcXCRwo",
            };
            axios
              .post("/honjaya/chats/ask/" + this.chatAskTo, { name: "a" }, { headers: headers })
              .then((response) => {
                let { data } = response;
                if (data.success && data.trueOrFalse) {
                  alert("방 개설 성공");
                  this.findAllRoom(); // <- 이거는 어차피 메인에서만 작동시키는 거라서 실제 서비스에서는 지우면 됨
                } else {
                  alert("상대가 신청 아직 안 함");
                }
              })
              .catch((response) => {
                alert("채팅 요청에 실패하였습니다.");
              });
          },
          enterRoom: function (chatroomNo) {
            let userNo;

            let headers = {
              "Content-Type": "application/json",
              Accept: "application/json",
              "access-token":
                "eyJ0eXAiOiJKV1QiLCJyZWdEYXRlIjoxNjYwMzE5NTYxMzUzLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NjAzNTU1NjEsInN1YiI6ImFjY2Vzcy10b2tlbiIsInVzZXJObyI6MX0.4p6UpRi17Ut-ZzkbOM6meZ8Lw5R2rct41YbVEcXCRwo",
            };
            axios.get("/honjaya/users/userno", { headers: headers }).then((response) => {
              let { data } = response;
              if (data.success) {
                userNo = data.userNo;
                localStorage.setItem("wschat.userNo", userNo);
                localStorage.setItem("wschat.chatroomNo", chatroomNo);
                // location.href = "/chat/room/enter/" + chatroomNo;
                window.open("./roomdetail.html");
              } else {
                console.log(data.error);
              }
            });
          },
        },
      });
    </script>
  </body>
</html>
