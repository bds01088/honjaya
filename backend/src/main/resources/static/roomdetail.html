<!DOCTYPE html>
<html
  lang="en"
  xmlns:v-on="http://www.w3.org/1999/xhtml"
  xmlns:v-bind="http://www.w3.org/1999/xhtml"
>
  <!-- <html lang="en" itemscope itemtype="http://schema.org/WebPage"> -->
  <head>
    <title>Websocket ChatRoom</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
      .mychat {
        background-color: yellow;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app" v-cloak>
      <div>
        <label id="staticBackdropLabel" for="nickname">{{opponentNickname}}</label>
        <button
          class="btn btn-default"
          type="button"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div style="height: 600px">
        <ul id="msgArea">
          <li v-for="message in messages" v-bind:class="{ 'mychat': userNo == message.userNo }">
            <span>
              <span>{{message.userNickname}}</span>
              <img
                v-if="userNo != message.userNo"
                style="width: 20px; height: 20px"
                src="https://png.pngtree.com/png-vector/20191009/ourmid/pngtree-user-icon-png-image_1796659.jpg"
                alt="any"
              />
              <!-- 이미지 태그에는 상대 유저의 프로필 이미지로 설정해야 함 -->
            </span>
            <span>{{message.chatTime}}</span>
            <span>{{message.chatMessage}}</span>
          </li>
        </ul>
      </div>

      <div>
        <span>
          <input type="text" v-model="chatMessage" v-on:keypress.enter="sendMessage" />
          <button class="btn btn-default" type="button" @click="sendMessage">전송</button>
        </span>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
      //alert(document.title);
      // websocket & stomp initialize
      var sockJs = new SockJS("/honjaya/stomp/chat");
      var stomp = Stomp.over(sockJs);
      var reconnect = 0;
      // vue.js
      var vm = new Vue({
        el: "#app",
        data: {
          chatroomNo: 0,
          room: {},
          opponentNo: 0,
          opponentNickname: "",
          userNo: "",
          chatMessage: "",
          messages: [],
        },
        created() {
          this.chatroomNo = localStorage.getItem("wschat.chatroomNo");
          this.userNo = localStorage.getItem("wschat.userNo");

          this.getChatroomDetail();
        },
        methods: {
          getChatroomDetail: function () {
            let headers = {
              "Content-Type": "application/json",
              Accept: "application/json",
              "access-token":
                "eyJ0eXAiOiJKV1QiLCJyZWdEYXRlIjoxNjYwMzE5NTYxMzUzLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NjAzNTU1NjEsInN1YiI6ImFjY2Vzcy10b2tlbiIsInVzZXJObyI6MX0.4p6UpRi17Ut-ZzkbOM6meZ8Lw5R2rct41YbVEcXCRwo",
            };
            axios
              .get("/honjaya/chats/chatroom/" + this.chatroomNo, { headers: headers })
              .then((response) => {
                let { data } = response;
                if (data.success) {
                  this.opponentNo = data.userNo;
                  this.opponentNickname = data.userNickname;
                } else {
                  alert("방 정보를 불러오는 데 실패하였습니다.");
                }
              })
              .catch((response) => {
                alert("방 정보를 불러오는 데 실패하였습니다.");
              });
          },
          sendMessage: function () {
            stomp.send(
              "/pub/chat/message",
              {},
              JSON.stringify({
                chatroomNo: this.chatroomNo,
                userNo: this.userNo,
                chatMessage: this.chatMessage,
              })
            );
            this.chatMessage = "";
          },
          recvMessage: function (recv) {
            this.messages.unshift({
              userNo: recv.userNo,
              userNickname: recv.userNickname,
              chatMessage: recv.chatMessage,
              chatTime: recv.chatTime,
            });
          },
        },
      });

      function connect() {
        // pub/sub event
        stomp.connect(
          {},
          function (frame) {
            console.log(vm.$data.chatroomNo);
            stomp.subscribe("/sub/chat/room/" + vm.$data.chatroomNo, function (message) {
              var recv = JSON.parse(message.body);
              vm.recvMessage(recv);
            });
            stomp.send(
              "/pub/chat/enter",
              {},
              JSON.stringify({
                chatroomNo: vm.$data.chatroomNo,
                userNo: vm.$data.userNo,
              })
            );
            console.log("구독 성공");
          },
          function (error) {
            if (reconnect++ <= 5) {
              setTimeout(function () {
                console.log("connection reconnect");
                sockJs = new SockJS("/honjaya/stomp/chat");
                stomp = Stomp.over(sockJs);
                connect();
              }, 10 * 1000);
            }
          }
        );
      }
      connect();
    </script>
  </body>
</html>
